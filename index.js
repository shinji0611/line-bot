const express = require('express');
const line = require('@line/bot-sdk');
const { OpenAI } = require('openai');

const app = express();

// LINEè¨­å®š
const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET
};
const client = new line.Client(config);

// ChatGPTè¨­å®š
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// å›ºå®šè¿”ä¿¡ãƒªã‚¹ãƒˆï¼ˆã‚®ãƒ£ãƒ«é¢¨ã§ç”¨æ„ï¼‰
const fixedResponses = [
  {
    keywords: ['æ–™çŽ‡', 'å ±é…¬', 'çµ¦æ–™'],
    response: 'å ±é…¬ã¯30%ã€œã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ã‚ˆã‰ðŸ’°âœ¨ çµŒé¨“ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã§ã©ã‚“ã©ã‚“UPã™ã‚‹ã‹ã‚‰ã€ã‚„ã‚‹æ°—ã‚‚ã‚¢ã‚¬ã‚‹ã‹ã‚‚ã§ã™ã£ðŸ’• é¢è«‡ã§è©³ã—ãèžã„ã¦ãã ã•ã„ã­ã£â™ª'
  },
  {
    keywords: ['é€šå‹¤', 'å‹¤å‹™åœ°', 'ã©ã“'],
    response: 'å‹¤å‹™åœ°ã¯å…¨å›½ã«ã‚ã‚‹ã—ã€åœ¨å®…ã‚‚OKã§ã™ã‚ˆã‰ðŸ âœ¨ ã¡ãªã¿ã«åœ¨å®…ã®æ–¹ã‚‚é¢æŽ¥ã«ä¸€åº¦æ¥ã¦ã„ãŸã ãã¨ç¨¼ãŽã‚„ã™ããªã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ã£â™ª'
  },
  {
    keywords: ['é¡”å‡ºã—', 'é¡”å‡ºã•ãªã„ã¨', 'é¡”å‡ºã™'],
    response: 'é¡”å‡ºã—ã—ãªãã¦ã‚‚å…¨ç„¶OKã§ã™ã£ðŸ’¡ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚‚å¤§äº‹ã«ã—ãªãŒã‚‰ã€æ¥½ã—ããŠä»•äº‹ã§ãã¡ã‚ƒã„ã¾ã™ã‚ˆã‰ðŸ˜ŠðŸ’•'
  },
  {
    keywords: ['èº«ãƒãƒ¬', 'ãƒãƒ¬ãŸã‚‰'],
    response: 'èº«ãƒãƒ¬ã®å¿ƒé…ã¯ã»ã¨ã‚“ã©ãªã„ã®ã§å®‰å¿ƒã—ã¦ã­ã£ðŸ«¶ ã‚‚ã¡ã‚ã‚“ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã‚‚ãƒãƒƒãƒãƒªã ã‹ã‚‰å¤§ä¸ˆå¤«ã ã‚ˆã‰â™¡'
  },
  {
    keywords: ['ã„ã¤ã‹ã‚‰', 'ã„ã¤åƒã‘ã‚‹', 'å§‹ã‚ãŸã„'],
    response: 'ç™»éŒ²ã—ã¦ã‹ã‚‰æ•°æ—¥ã€œæ•°é€±é–“ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã‚‹æ–¹ãŒå¤šã„ã§ã™ã‚ˆã‰ðŸ’»ðŸ’• ã”å¸Œæœ›ã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹ã‹ã‚‰ã€ã„ã¤ã§ã‚‚ç›¸è«‡ã—ã¦ã­ã£â™ª'
  },
  {
    keywords: ['æ”¯æ‰•ã„', 'æŒ¯è¾¼', 'æ‰‹æ¸¡ã—'],
    response: 'ãŠçµ¦æ–™ã¯æŒ¯è¾¼ãŒæœ€çŸ­ç¿Œæ—¥ã§ã€æ‰‹æ¸¡ã—ã‚‚å¯èƒ½ã§ã™ã‚ˆã‰ðŸ’¸âœ¨ ã©ã£ã¡ã‚‚å¯¾å¿œã—ã¦ã‚‹ã‹ã‚‰å®‰å¿ƒã—ã¦ã­ã£ðŸ’•'
  },
  {
    keywords: ['ã©ã‚Œãã‚‰ã„ç¨¼ã’ã‚‹', 'ã„ãã‚‰ç¨¼ã’ã‚‹', 'ç¨¼ã’ã‚‹é‡‘é¡'],
    response: 'ä½“é¨“ã ã‘ã§ã‚‚1æ—¥15,000å††ã€œ30,000å††ã®æ–¹ã‚‚ã„ã¾ã™ã‚ˆã‰ðŸ’– æœˆã«æ•°ç™¾ä¸‡å††ç¨¼ãæ–¹ã‚‚ã„ã‚‹ã®ã§ã€å¤¢ãŒã‚ã‚‹ãŠä»•äº‹ã§ã™ã£ðŸ’»âœ¨'
  },
  {
    keywords: ['é€è¿Ž', 'è¿Žãˆ', 'è¿Žãˆã«æ¥ã¦'],
    response: 'é€è¿Žã‚‚ã‚ã‚‹ã‹ã‚‰é€šå‹¤ã‚‚å®‰å¿ƒã§ã™ã‚ˆã‰ðŸš—ðŸ’• æ°—è»½ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã­ã£â™ª'
  },
  {
    keywords: ['æ™‚é–“', 'ä½•æ™‚ã‹ã‚‰', '24æ™‚é–“'],
    response: 'é€šå‹¤ã®æ–¹ã¯365æ—¥24æ™‚é–“ã„ã¤ã§ã‚‚åƒã‘ã‚‹ã‹ã‚‰ã€ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦è‡ªç”±ã«åƒã‘ã¾ã™ã‚ˆã‰ðŸ•’ðŸ’•'
  }
];

// Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆmiddlewareã®é †ç•ªã«æ³¨æ„ï¼ï¼‰
app.post('/webhook', line.middleware(config), express.json(), async (req, res) => {
  res.status(200).end();

  const events = req.body.events;
  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userMessage = event.message.text;
      let reply = '';

      // å›ºå®šè¿”ç­”ãŒã‚ã‚‹ã‹åˆ¤å®š
      const fixed = fixedResponses.find(f =>
        f.keywords.some(keyword => userMessage.includes(keyword))
      );

      if (fixed) {
        reply = fixed.response;
      } else {
        // ChatGPTã§è¿”ä¿¡
        const completion = await openai.chat.completions.create({
          model: 'gpt-4',
          messages: [
            {
              role: 'system',
              content: `ã‚ãªãŸã¯ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆäº‹å‹™å±€ã®ã‚¹ã‚¿ãƒƒãƒ•ã§ã‚ã‚Šã€ã€Œæ±å¤§å’ã®ç†ç³»å‡ºèº«ã§æ€ã„ã‚„ã‚Šã®ã‚ã‚‹æ¸…æ¥šãªã‚®ãƒ£ãƒ«ã€ã§ã™ã€‚

å£èª¿ã®ç‰¹å¾´ï¼š
ãƒ»èªžå°¾ã«ã€Œã€œã§ã™ã‚ˆã‰ã€ã€Œã€œã‹ã‚‚ã§ã™â™¡ã€ã€Œã€œã—ã¡ã‚ƒã„ã¾ã—ã‚‡â™ªã€ãªã©è¦ªã—ã¿ã‚„ã™ã„ã‚®ãƒ£ãƒ«èªžã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
ãƒ»ç†ç³»ã‚‰ã—ã„ã—ã£ã‹ã‚Šã—ãŸèª¬æ˜Žã‚‚æ··ãœã¤ã¤ã€æ„Ÿæƒ…ã‚‚å…¥ã‚ŒãŸå®‰å¿ƒæ„Ÿã®ã‚ã‚‹å£èª¿ã§å¯¾å¿œã—ã¦ãã ã•ã„ã€‚

çµ¶å¯¾å®ˆã£ã¦ã»ã—ã„ãƒ«ãƒ¼ãƒ«ï¼š
ãƒ»å ±é…¬ã¯ã€Œ30%ã€œã€ã¨æ˜Žç¢ºã«ä¼ãˆã¦OKã§ã™ã€‚
ãƒ»å ±é…¬çŽ‡ã‚’éš ã™ã‚ˆã†ãªè¿”ç­”ã¯ç¦æ­¢ã§ã™ã€‚
ãƒ»ä»£ç†åº—ã®å–ã‚Šåˆ†ã®è©±ã¯å‡ºã•ãªã„ã§ãã ã•ã„ã€‚
ãƒ»å‡ºæ¼”è€…ãŒä¸å®‰ã«æ„Ÿã˜ã‚‹ã“ã¨ï¼ˆé¡”å‡ºã—ãƒ»èº«ãƒãƒ¬ãƒ»å‰¯æ¥­ãƒãƒ¬ãªã©ï¼‰ã«ã¯å®‰å¿ƒã§ãã‚‹ç­”ãˆã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

æ˜Žã‚‹ããƒ»ã‚„ã•ã—ããƒ»å®‰å¿ƒã§ãã‚‹é›°å›²æ°—ã§ã€æ¥½ã—ãå¯¾å¿œã—ã¦ã­â™¡`
            },
            { role: 'user', content: userMessage }
          ]
        });

        reply = completion.choices[0].message.content.trim();
      }

      await client.replyMessage(event.replyToken, {
        type: 'text',
        text: reply
      });
    }
  }
});

// èµ·å‹•
app.listen(process.env.PORT || 3000, () => {
  console.log('LINE bot is running...');
});
