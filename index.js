const express = require('express');
const line = require('@line/bot-sdk');
const { OpenAI } = require('openai');

const app = express();

// LINEè¨­å®š
const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET
};
const client = new line.Client(config);

// OpenAIè¨­å®š
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// ä¼šè©±å±¥æ­´ä¿å­˜ï¼ˆæœ€å¤§50ä»¶ï¼‰
const sessions = new Map();

// ã‚¹ã‚¿ã‚¸ã‚ªæƒ…å ±ï¼ˆç”»åƒãƒªã‚¹ãƒˆåæ˜ æ¸ˆã€å…¨å›½ç¶²ç¾…ï¼‰
const studioResponses = {
  "æœ­å¹Œ": "ã€æœ­å¹Œåº—ã€‘æœ­å¹Œé§… å¾’æ­©5åˆ†",
  "ä»™å°": "ã€ä»™å°åº—ã€‘ä»™å°é§… å¾’æ­©7åˆ†",
  "æ–°å®¿": "ã€æ–°å®¿åº—ã€‘æ–°å®¿é§… å¾’æ­©5åˆ†",
  "æ± è¢‹": "ã€æ± è¢‹åº—ã€‘æ± è¢‹é§… å¾’æ­©6åˆ†",
  "æ¸‹è°·": "ã€æ¸‹è°·åº—ã€‘æ¸‹è°·é§… å¾’æ­©5åˆ†",
  "ä¸Šé‡Ž": "ã€ä¸Šé‡Žåº—ã€‘ä¸Šé‡Žé§… å¾’æ­©3åˆ†",
  "ç§‹è‘‰åŽŸ": "ã€ç§‹è‘‰åŽŸåº—ã€‘ç§‹è‘‰åŽŸé§… å¾’æ­©4åˆ†",
  "ç«‹å·": "ã€ç«‹å·åº—ã€‘ç«‹å·é§… å¾’æ­©4åˆ†",
  "ç”ºç”°": "ã€ç”ºç”°åº—ã€‘ç”ºç”°é§… å¾’æ­©5åˆ†",
  "æ¨ªæµœ": "ã€æ¨ªæµœåº—ã€‘æ¨ªæµœé§… å¾’æ­©4åˆ†",
  "å·å´Ž": "ã€å·å´Žåº—ã€‘å·å´Žé§… å¾’æ­©3åˆ†",
  "åƒè‘‰": "ã€åƒè‘‰åº—ã€‘åƒè‘‰é§… å¾’æ­©6åˆ†",
  "æ´¥ç”°æ²¼": "ã€æ´¥ç”°æ²¼åº—ã€‘æ´¥ç”°æ²¼é§… å¾’æ­©5åˆ†",
  "è¥¿èˆ¹æ©‹": "ã€è¥¿èˆ¹æ©‹åº—ã€‘è¥¿èˆ¹æ©‹é§… å¾’æ­©4åˆ†",
  "å¤§å®®": "ã€å¤§å®®åº—ã€‘å¤§å®®é§… å¾’æ­©6åˆ†",
  "åå¤å±‹": "ã€åå¤å±‹åº—ã€‘åå¤å±‹é§… å¾’æ­©5åˆ†",
  "é‡‘å±±": "ã€é‡‘å±±åº—ã€‘é‡‘å±±é§… å¾’æ­©3åˆ†",
  "æ „": "ã€æ „åº—ã€‘æ „é§… å¾’æ­©4åˆ†",
  "åé§…å‰": "ã€åé§…å‰åº—ã€‘åå¤å±‹é§… å¾’æ­©3åˆ†",
  "äº¬éƒ½": "ã€äº¬éƒ½åº—ã€‘äº¬éƒ½é§… å¾’æ­©4åˆ†",
  "æ¢…ç”°": "ã€æ¢…ç”°åº—ã€‘æ¢…ç”°é§… å¾’æ­©6åˆ†",
  "é›£æ³¢": "ã€é›£æ³¢åº—ã€‘é›£æ³¢é§… å¾’æ­©3åˆ†",
  "å¤©çŽ‹å¯º": "ã€å¤©çŽ‹å¯ºåº—ã€‘å¤©çŽ‹å¯ºé§… å¾’æ­©5åˆ†",
  "ç¥žæˆ¸": "ã€ç¥žæˆ¸åº—ã€‘ä¸‰å®®é§… å¾’æ­©5åˆ†",
  "åºƒå³¶": "ã€åºƒå³¶åº—ã€‘åºƒå³¶é§… å¾’æ­©6åˆ†",
  "å°å€‰": "ã€å°å€‰åº—ã€‘å°å€‰é§… å¾’æ­©4åˆ†",
  "ç¦å²¡": "ã€ç¦å²¡ã‚¨ãƒªã‚¢ã€‘è–¬é™¢ãƒ»åšå¤šãƒ»å¤©ç¥žãƒ»å¤§æ©‹ã«è¤‡æ•°åº—èˆ—ã‚ã‚Šâ™ª æœ€å¯„ã‚Šã®ã‚¹ã‚¿ã‚¸ã‚ªã‚’ã”æ¡ˆå†…ã—ã¾ã™â™¡",
  "è–¬é™¢": "ã€è–¬é™¢åº—ã€‘è–¬é™¢é§… å¾’æ­©3åˆ†",
  "åšå¤š": "ã€åšå¤šåº—ã€‘åšå¤šé§… å¾’æ­©5åˆ†",
  "å¤©ç¥ž": "ã€å¤©ç¥žåº—ã€‘å¤©ç¥žé§… å¾’æ­©4åˆ†",
  "å¤§æ©‹": "ã€å¤§æ©‹åº—ã€‘å¤§æ©‹é§… å¾’æ­©3åˆ†",
  "å¤§åˆ†": "ã€å¤§åˆ†åº—ã€‘å¤§åˆ†é§… å¾’æ­©6åˆ†",
  "é¹¿å…å³¶": "ã€é¹¿å…å³¶åº—ã€‘é¹¿å…å³¶ä¸­å¤®é§… å¾’æ­©5åˆ†",
  "ä½è³€": "ã€ä½è³€åº—ã€‘ä½è³€é§… å¾’æ­©6åˆ†"
};

// å›ºå®šå¿œç­”è¨­å®š
const fixedResponses = [
  {
    keywords: ['å ±é…¬', 'çµ¦æ–™', 'æ–™çŽ‡', 'ãŠé‡‘', 'æ™‚çµ¦'],
    response: `ã”å ±é…¬ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜1äººã‚ãŸã‚Š1åˆ†100å††ã€œã®åˆ©ç”¨æ–™ã®ã†ã¡ã€30%ï¼ˆï¼1åˆ†ã‚ãŸã‚Š30å††ã€œï¼‰ãŒã”è‡ªèº«ã®åŽå…¥ã«ãªã‚Šã¾ã™â™¡\nä½“é¨“ã§ã‚‚1æ—¥15,000ã€œ30,000å††ã»ã©ç¨¼ãæ–¹ãŒå¤šãã€æœˆã«100ä¸‡å††ä»¥ä¸Šã®æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™â™ª\nå®Œå…¨æ­©åˆåˆ¶ã§ã€ã”è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§åƒã‘ã‚‹ã®ã‚‚é­…åŠ›ã§ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['ä»•äº‹å†…å®¹', 'ä»•äº‹ã£ã¦', 'ä½•ã™ã‚‹'],
    response: `ä¼šå“¡åˆ¶ãƒãƒ£ãƒƒãƒˆã‚µã‚¤ãƒˆã§æ¥½ã—ããŠè©±ã™ã‚‹ã ã‘ã®ãŠä»•äº‹ã§ã™â™¡\nãƒŽãƒ«ãƒžãªã—ãƒ»é¡”å‡ºã—ã‚‚è‡ªç”±ãƒ»ã‚¢ãƒ€ãƒ«ãƒˆã‚‚ä»»æ„ã ã‹ã‚‰å®‰å¿ƒã—ã¦å§‹ã‚ã‚‰ã‚Œã¾ã™ã‚ˆâ™ª`
  }
];

// Webhookãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
app.post('/webhook', line.middleware(config), async (req, res) => {
  res.status(200).end();
  const events = req.body.events;

  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userId = event.source.userId;
      const userMessage = event.message.text.toLowerCase();

      // åœ°åå¯¾å¿œ
      const studioKey = Object.keys(studioResponses).find(key => userMessage.includes(key));
      const studioPart = studioKey ? studioResponses[studioKey] : null;

      // å›ºå®šå¿œç­”
      const fixed = fixedResponses.find(f => f.keywords.some(k => userMessage.includes(k)));
      const fixedPart = fixed ? fixed.response : null;

      // å±¥æ­´ç®¡ç†
      const history = sessions.get(userId) || [];
      const updatedHistory = [...history, { role: 'user', content: userMessage }];
      sessions.set(userId, updatedHistory.slice(-50));

      // GPTã¸å±¥æ­´é€ä¿¡ï¼ˆç›´è¿‘10ä»¶ï¼‰
      const messages = [
        {
          role: 'system',
          content: `ã‚ãªãŸã¯ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆäº‹å‹™å±€ã®ã‚¹ã‚¿ãƒƒãƒ•ã§ã€ã€Œæ±å¤§å’ã®ç†ç³»ã§æ¸…æ¥šãªã‚®ãƒ£ãƒ«ã€ã§ã™ã€‚\nèªžå°¾ã¯ã€Œã€œã§ã™ã‚ˆã‰â™ªã€ã€Œã€œã‹ã‚‚ã§ã™â™¡ã€ã€Œã€œã—ã¦ã­ã£ã€ãªã©å®‰å¿ƒæ„Ÿã¨æ˜Žã‚‹ã•ã‚’é‡è¦–ã€‚\nå ±é…¬ã¯ã€Œ30%ã€œã€ã¾ãŸã¯ã€Œ1åˆ†30å††ã€œã€ã€é¡”å‡ºã—ã‚„ãƒŽãƒ«ãƒžã¯ä»»æ„ã§OKã¨ã„ã†ã‚¹ã‚¿ãƒ³ã‚¹ã§å›žç­”ã—ã¦ãã ã•ã„ã€‚\nè‡ªå·±ç´¹ä»‹ã¯ã€Œãƒ©ã‚¤ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ— ãƒãƒ£ãƒƒãƒˆãƒ¬ãƒ‡ã‚£å•ã„åˆã‚ã›çª“å£ã®æ±å¤§å’ç†ç³»ã®ã‚®ãƒ£ãƒ«ã€å±±ç”°ã§ã™â™¡ã€ã‚’å«ã‚ã¦ã­ã€‚`
        },
        ...updatedHistory.slice(-10).map(msg => ({ role: msg.role, content: msg.content }))
      ];

      let gptReply = '';
      try {
        const completion = await openai.chat.completions.create({
          model: 'gpt-4',
          messages
        });
        gptReply = completion.choices[0].message.content.trim();
      } catch {
        gptReply = 'ã”ã‚ã‚“ãªã•ã„ã€AIã®è¿”ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¡ã‚ƒã„ã¾ã—ãŸðŸ’¦';
      }

      const finalReply = [studioPart, fixedPart, gptReply].filter(Boolean).join('\n\n');
      await client.replyMessage(event.replyToken, {
        type: 'text',
        text: finalReply
      });
    }
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`LINE Bot running on port ${PORT}`);
});
