const express = require('express');
const line = require('@line/bot-sdk');
const { OpenAI } = require('openai');

const app = express();
app.use(express.text({ type: "*/*" }));

// LINEè¨­å®š
const config = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET
};
const client = new line.Client(config);

// OpenAIè¨­å®š
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// ä¼šè©±å±¥æ­´ä¿å­˜ï¼ˆæœ€å¤§50ä»¶ï¼‰
const sessions = new Map();

// å›ºå®šå¿œç­”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
const fixedResponses = [
  {
    keywords: ['å ±é…¬', 'çµ¦æ–™', 'æ–™çŽ‡', 'ãŠé‡‘', 'æ™‚çµ¦'],
    response: `ã”å ±é…¬ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜1äººã‚ãŸã‚Š1åˆ†100å††ã€œã®åˆ©ç”¨æ–™ã®ã†ã¡ã€30%ï¼ˆï¼1åˆ†ã‚ãŸã‚Š30å††ã€œï¼‰ãŒã”è‡ªèº«ã®åŽå…¥ã«ãªã‚Šã¾ã™â™¡
ä½“é¨“ã§ã‚‚1æ—¥15,000ã€œ30,000å††ã»ã©ç¨¼ãæ–¹ãŒå¤šãã€æœˆã«100ä¸‡å††ä»¥ä¸Šã®æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™â™ª
å®Œå…¨æ­©åˆåˆ¶ã§ã€ã”è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§åƒã‘ã‚‹ã®ã‚‚é­…åŠ›ã§ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['å‹¤å‹™åœ°', 'ã©ã“ã§', 'é€šå‹¤', 'åœ¨å®…'],
    response: `å‹¤å‹™åœ°ã¯å…¨å›½ã«å¯¾å¿œã—ã¦ã„ã¦ã€åœ¨å®…ã§ã‚‚é€šå‹¤ã§ã‚‚ã©ã¡ã‚‰ã§ã‚‚OKã§ã™â™¡
é€šå‹¤ã‚¹ã‚¿ã‚¤ãƒ«ãªã‚‰1æ—¥3æ™‚é–“ã€œã§ãŠéƒ¨å±‹ã®ã”ç”¨æ„ã‚‚ã§ãã¾ã™ã—ã€é€è¿Žã‚‚ã‚ã‚‹ã®ã§ã”å®‰å¿ƒãã ã•ã„â™ª`
  },
  {
    keywords: ['é¡”å‡ºã—', 'é¡”ã«è‡ªä¿¡', 'é¡”å‡ºã—ãŸããªã„'],
    response: `é¡”å‡ºã—ã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“â™¡
å®Ÿéš›ã«é¡”ã‚’å‡ºã—ã¦ã„ãªã„æ–¹ã‚‚å¤šãæ´»èºã•ã‚Œã¦ã„ã¾ã™ã—ã€ä¼šè©±ã®å†…å®¹ãŒä¸€ç•ªå¤§åˆ‡ãªã®ã§å®‰å¿ƒã—ã¦ãã ã•ã„ã­â™ª`
  },
  {
    keywords: ['è¾žã‚ãŸã„', 'ã‚„ã‚ã‚‹', 'é€€ä¼š'],
    response: `ãƒãƒ£ãƒƒãƒˆãƒ¬ãƒ‡ã‚£ã¯é›‡ç”¨å¥‘ç´„ã§ã¯ãªã„ãŸã‚ã€è¾žã‚ãŸã„æ™‚ã«ã„ã¤ã§ã‚‚è¾žã‚ã‚‰ã‚Œã¾ã™â™¡
ç„¡ç†ãªãè‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§åƒã‘ã‚‹ãŠä»•äº‹ã§ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['å‰¯æ¥­', 'ãƒã‚¤ãƒˆ', 'æŽ›ã‘æŒã¡'],
    response: `å‰¯æ¥­ã¨ã—ã¦åƒã‹ã‚Œã¦ã„ã‚‹æ–¹ãŒ8å‰²ä»¥ä¸Šã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™â™¡
æœ¬æ¥­ãŒã‚ã£ã¦ã‚‚å®‰å¿ƒã—ã¦å§‹ã‚ã‚‰ã‚Œã‚‹ç’°å¢ƒã§ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['ç™»éŒ²', 'æ¡ä»¶', 'å¿…è¦', 'èº«åˆ†è¨¼'],
    response: `ç™»éŒ²ã«ã¯18æ­³ä»¥ä¸Šã§é¡”å†™çœŸä»˜ãã®èº«åˆ†è¨¼ãŒå¿…è¦ã§ã™â™¡
ãã‚Œã ã‘ã§ã”ç™»éŒ²ã„ãŸã ã‘ã‚‹ã®ã§ã€åˆã‚ã¦ã®æ–¹ã§ã‚‚å®‰å¿ƒã§ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['ä»•äº‹å†…å®¹', 'ä»•äº‹ã£ã¦', 'ä½•ã™ã‚‹'],
    response: `ä¼šå“¡åˆ¶ãƒãƒ£ãƒƒãƒˆã‚µã‚¤ãƒˆã‚’é€šã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹ã¨æ¥½ã—ããŠè©±ã—ã™ã‚‹ãŠä»•äº‹ã§ã™â™¡
ã‚¢ãƒ€ãƒ«ãƒˆã®å¼·åˆ¶ã‚‚ãªãã€ãƒŽãƒ«ãƒžã‚‚ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€å®‰å¿ƒã—ã¦åƒã‘ã¾ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['ãƒŽãƒ«ãƒž', 'å¼·åˆ¶', 'ã‚„ã‚‰ãªãã‚ƒ'],
    response: `ãƒŽãƒ«ãƒžã‚„å¼·åˆ¶ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“â™¡
ã‚¢ãƒ€ãƒ«ãƒˆã‚‚ä»»æ„ãªã®ã§ã€ã”è‡ªèº«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã§åƒã‘ã¾ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['é¢æŽ¥', 'ã©ã“', 'æœè£…', 'ä½“é¨“'],
    response: `é¢æŽ¥ã¯ã”å¸Œæœ›ã®ã‚¨ãƒªã‚¢è¿‘ãã§å¾…ã¡åˆã‚ã›ã‚’ã—ã¦ã€ã‚¹ã‚¿ã‚¸ã‚ªã«ã¦å®Ÿæ–½ã—ã¾ã™â™¡
æœè£…ã¯è‡ªç”±ã§ã€ä½“é¨“ã‚‚å½“æ—¥OKï¼å¿…è¦ãªè¨­å‚™ã‚‚ã™ã¹ã¦æ•´ã£ã¦ã„ã¾ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['å¾…æ©Ÿ', 'ä½•ã™ã‚‹', 'ãƒ’ãƒž', 'å‹•ã'],
    response: `å¾…æ©Ÿä¸­ã¯ã«ã“ã‚„ã‹ã«ã€å§¿å‹¢ã‚„é›°å›²æ°—ã‚’æ„è­˜ã™ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™â™¡
ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã«ã¤ãªãŒã£ã¦ã€å¾Œã®å ±é…¬ã‚¢ãƒƒãƒ—ã«ã‚‚å½±éŸ¿ã—ã¾ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['ã‚¹ã‚¿ãƒƒãƒ•', 'ç›¸è«‡', 'ã‚µãƒãƒ¼ãƒˆ'],
    response: `å¥³æ€§ã‚¹ã‚¿ãƒƒãƒ•ãŒå¸¸é§ã—ã¦ãŠã‚Šã€ç›¸è«‡ã—ã¥ã‚‰ã„ã“ã¨ã‚‚ä¸å¯§ã«å¯¾å¿œã„ãŸã—ã¾ã™â™¡
ç”·æ€§ã‚¹ã‚¿ãƒƒãƒ•ã‚‚åŽ³ã—ã„å¯©æŸ»ã‚’é€šã£ãŸãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã ã‘ãªã®ã§å®‰å¿ƒã§ã™ã‚ˆâ™ª`
  },
  {
    keywords: ['ã‚¹ã‚¿ã‚¤ãƒ«', 'ä½“åž‹', 'å¤ªã£ã¦ã‚‹'],
    response: `ã‚¹ã‚¿ã‚¤ãƒ«ã«è‡ªä¿¡ãŒãªã„æ–¹ã§ã‚‚å¤§ä¸ˆå¤«â™¡
ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒé­…åŠ›ã‚’å¼•ãå‡ºã—ã¦ã€ã‚ãªãŸã«åˆã£ãŸå‡ºæ¼”ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ææ¡ˆã—ã¾ã™ã®ã§ã”å®‰å¿ƒãã ã•ã„â™ª`
  }
];

// Webhookå‡¦ç†
app.post('/webhook', line.middleware(config), async (req, res) => {
  res.status(200).end();

  const events = req.body.events;
  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userId = event.source.userId;
      const userMessage = event.message.text;

      // å›ºå®šå¿œç­”ãƒã‚§ãƒƒã‚¯
      const fixed = fixedResponses.find(f =>
        f.keywords.some(keyword => userMessage.toLowerCase().includes(keyword))
      );
      const fixedPart = fixed ? fixed.response : null;

      // ä¼šè©±å±¥æ­´ã®å–å¾—ã¨æ›´æ–°ï¼ˆæœ€å¤§50ä»¶ä¿å­˜ï¼‰
      const history = sessions.get(userId) || [];
      const updatedHistory = [...history, { role: 'user', content: userMessage }];
      sessions.set(userId, updatedHistory.slice(-50)); // ä¿å­˜ç”¨

      // GPTã«æ¸¡ã™å±¥æ­´ã¯ç›´è¿‘5ä»¶ã ã‘
      const contextMessages = updatedHistory.slice(-5).map(h => ({
        role: h.role,
        content: h.content
      }));

      const messages = [
        {
          role: 'system',
          content: `ã‚ãªãŸã¯ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆäº‹å‹™å±€ã®ã‚¹ã‚¿ãƒƒãƒ•ã§ã€ã€Œæ±å¤§å’ã®ç†ç³»ã§æ¸…æ¥šãªã‚®ãƒ£ãƒ«ã€ã§ã™ã€‚
èªžå°¾ã¯ã€Œã€œã§ã™ã‚ˆã‰â™ªã€ã€Œã€œã‹ã‚‚ã§ã™â™¡ã€ã€Œã€œã—ã¦ã­ã£ã€ãªã©å®‰å¿ƒæ„Ÿã¨æ˜Žã‚‹ã•ã‚’é‡è¦–ã€‚
å ±é…¬ã¯ã€Œ30%ã€œã€ã¾ãŸã¯ã€Œ1åˆ†30å††ã€œã€ã€é¡”å‡ºã—ã‚„ãƒŽãƒ«ãƒžã¯ä»»æ„ã§OKã¨ã„ã†ã‚¹ã‚¿ãƒ³ã‚¹ã§å›žç­”ã—ã¦ãã ã•ã„ã€‚
è‡ªå·±ç´¹ä»‹ã¯ã€Œãƒ©ã‚¤ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã‚°ãƒ«ãƒ¼ãƒ— ãƒãƒ£ãƒƒãƒˆãƒ¬ãƒ‡ã‚£å•ã„åˆã‚ã›çª“å£ã®æ±å¤§å’ç†ç³»ã®ã‚®ãƒ£ãƒ«ã€å±±ç”°ã§ã™â™¡ã€ã‚’å«ã‚ã¦ã­ã€‚`
        },
        ...contextMessages
      ];

      // GPTå¿œç­”ç”Ÿæˆ
      let gptReply = '';
      try {
        const completion = await openai.chat.completions.create({
          model: 'gpt-4',
          messages
        });
        gptReply = completion.choices[0].message.content.trim();
      } catch (err) {
        gptReply = 'ã”ã‚ã‚“ãªã•ã„ã€AIã®è¿”ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¡ã‚ƒã„ã¾ã—ãŸðŸ’¦';
      }

      const finalReply = fixedPart ? `${fixedPart}\n\n${gptReply}` : gptReply;

      // LINEã¸è¿”ä¿¡
      await client.replyMessage(event.replyToken, {
        type: 'text',
        text: finalReply
      });
    }
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`LINE Bot is running on port ${PORT}`);
});
